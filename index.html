<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nepal Accounting AI & Tax Calculator</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root { --primary: #003893; --secondary: #dc143c; --bg: #f4f7f6; --success: #28a745; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: var(--bg); margin: 0; padding: 10px; line-height: 1.6; }
        .container { max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 5px 25px rgba(0,0,0,0.1); border-top: 8px solid var(--primary); }
        h2 { color: var(--primary); text-align: center; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .section { margin-bottom: 25px; padding: 15px; border: 1px solid #eee; border-radius: 10px; background: #fff; }
        h3 { margin-top: 0; color: #333; font-size: 1.1rem; border-left: 4px solid var(--secondary); padding-left: 10px; }
        input, select, textarea { width: 100%; padding: 12px; margin-top: 10px; border: 2px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 15px; transition: 0.3s; }
        input:focus, textarea:focus { border-color: var(--primary); outline: none; }
        button { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 15px; font-size: 16px; transition: 0.3s; }
        button:hover { opacity: 0.9; transform: translateY(-1px); }
        button:disabled { background: #ccc; cursor: not-allowed; }
        
        /* Key Setup Styling */
        .key-setup { background: #fff5f5; border: 1px dashed var(--secondary); padding: 15px; border-radius: 10px; margin-bottom: 20px; }
        .key-setup p { margin: 0 0 10px 0; font-size: 14px; font-weight: bold; color: var(--secondary); }
        
        #vatResult, #aiResult { margin-top: 20px; padding: 15px; background: #fafafa; border-radius: 8px; border: 1px solid #eee; min-height: 50px; overflow-x: auto; }
        
        /* Journal Table Styling */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; font-size: 14px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background: #f8f9fa; color: var(--primary); font-weight: bold; }
        .loading { color: var(--secondary); font-weight: bold; text-align: center; }
        .badge { background: var(--success); color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px; }
    </style>
</head>
<body>

<div class="container">
    <h2>üá≥üáµ Nepal Tax & Accounting AI</h2>

    <div class="key-setup" id="keyConfig">
        <p>üîë API Setup Required</p>
        <span style="font-size: 12px; color: #666;">OpenRouter bata naya key liyera yaha halnus. Yo mobile ma matra save hunchha.</span>
        <input type="password" id="userApiKey" placeholder="sk-or-v1-xxxxxxxxxxxxxxxxxxxxxxx">
        <button onclick="saveKey()" style="background: var(--success); padding: 10px; margin-top: 10px;">Connect AI Expert</button>
    </div>

    <div class="section">
        <h3>üìä Manual VAT Calculator</h3>
        <input type="number" id="vatAmt" placeholder="Enter Amount (NPR)">
        <select id="vatType">
            <option value="exclusive">VAT Exclusive (Add 13% VAT)</option>
            <option value="inclusive">VAT Inclusive (Extract 13% VAT)</option>
        </select>
        <button onclick="calcVAT()">Calculate VAT</button>
        <div id="vatResult">Calculation result will appear here...</div>
    </div>

    <div class="section">
        <h3>üí¨ AI Journal & Tax Advisor <span id="statusBadge"></span></h3>
        <textarea id="aiQ" rows="4" placeholder="Example: Purchased a computer for 80,000 from a VAT vendor. Paid 1.5% TDS. Show journal entry."></textarea>
        <button id="askBtn" onclick="askAI()">Generate Journal Entry</button>
        <div id="aiResult">AI response will be displayed here...</div>
    </div>
    
    <button onclick="clearKey()" style="background: #666; font-size: 12px; padding: 8px; margin-top: 20px;">Reset API Key</button>
</div>

<script>
// --- API KEY MANAGEMENT ---
function saveKey() {
    const key = document.getElementById('userApiKey').value.trim();
    if(key.startsWith('sk-or-v1-')) {
        localStorage.setItem('nepal_tax_ai_key', key);
        alert("‚úÖ API Key saved locally! AI is now ready.");
        location.reload();
    } else {
        alert("‚ùå Invalid Key! sk-or-v1- bata suru bhayeko key halnus.");
    }
}

function clearKey() {
    if(confirm("Are you sure you want to reset the API Key?")) {
        localStorage.removeItem('nepal_tax_ai_key');
        location.reload();
    }
}

window.onload = function() {
    const key = localStorage.getItem('nepal_tax_ai_key');
    if(key) {
        document.getElementById('keyConfig').style.display = 'none';
        document.getElementById('statusBadge').innerHTML = '<span class="badge">Connected</span>';
    }
}

// --- VAT CALCULATOR LOGIC ---
function calcVAT(){
    let amt = parseFloat(document.getElementById('vatAmt').value);
    let type = document.getElementById('vatType').value;
    if(isNaN(amt)) return alert("Please enter a valid amount");

    let base, vat, total;
    if(type === "exclusive"){
        base = amt;
        vat = amt * 0.13;
        total = amt + vat;
    } else {
        base = amt / 1.13;
        vat = amt - base;
        total = amt;
    }
    document.getElementById('vatResult').innerHTML = `
        <div style="color:#333;">
            <b>Base Amount:</b> Rs. ${base.toLocaleString(undefined, {minimumFractionDigits: 2})} <br>
            <b>VAT (13%):</b> Rs. ${vat.toLocaleString(undefined, {minimumFractionDigits: 2})} <br>
            <hr>
            <b style="color:var(--primary)">Grand Total: Rs. ${total.toLocaleString(undefined, {minimumFractionDigits: 2})}</b>
        </div>
    `;
}

// --- AI ACCOUNTING LOGIC ---
async function askAI(){
    const storedKey = localStorage.getItem('nepal_tax_ai_key');
    if(!storedKey) {
        alert("Pahila API Key setup garnus!");
        return;
    }

    const question = document.getElementById('aiQ').value;
    const resultDiv = document.getElementById('aiResult');
    const btn = document.getElementById('askBtn');

    if(!question) return alert("Kichha sodhnubhayeko chhaina!");
    
    resultDiv.innerHTML = "<p class='loading'>üîÑ Analyzing per Nepal Tax Law (2082/83)...</p>";
    btn.disabled = true;

    try {
        const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": "Bearer " + storedKey,
                "HTTP-Referer": window.location.origin,
                "X-Title": "Nepal Accounting AI"
            },
            body: JSON.stringify({
              "model": "google/gemini-2.5-flash:free",
                "messages": [
                    {
                        "role": "system",
                        "content": "You are a professional Chartered Accountant of Nepal. Answer in Roman Nepali and English. Use Journal Tables (Date, Particulars, L.F., Debit Rs., Credit Rs.). Apply Nepal's Income Tax Act 2058 and VAT Act 2052. TDS rules: 1.5% for VAT service, 15% for non-VAT, 10% for rent."
                    },
                    { "role": "user", "content": question }
                ]
            })
        });

        const data = await response.json();
        
        if (data.choices && data.choices[0]) {
            const markdownText = data.choices[0].message.content;
            resultDiv.innerHTML = marked.parse(markdownText);
        } else if (data.error) {
            resultDiv.innerHTML = "‚ùå AI Error: " + data.error.message;
            if(data.error.code === 401) localStorage.removeItem('nepal_tax_ai_key');
        } else {
            resultDiv.innerHTML = "‚ùå Unexpected Error. Please try again.";
        }
    } catch (error) {
        resultDiv.innerHTML = "‚ùå Connection Error: " + error.message;
    } finally {
        btn.disabled = false;
    }
}
</script>
</body>
</html>